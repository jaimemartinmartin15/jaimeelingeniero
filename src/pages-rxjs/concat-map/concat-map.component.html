<div class="page-header">
  <h1 class="title">ConcatMap</h1>
  <a class="link-rxjs" href="https://rxjs.dev/api/operators/concatMap" target="_blank">rxjs concatMap ‚û°Ô∏è</a>
</div>

<p>
  Este operador coge cada uno de los elementos emitidos por un Observable fuente y devuelve, por orden, un nuevo
  Observable por cada elemento. Es decir, hasta que no se completa el nuevo Observable, no crea uno nuevo para el
  siguiente elemento en el Observable fuente. Los elementos del nuevo Observable son puestos en el Obsevable fuente
  y son entregados al subscriptor.
</p>

<textarea highlight-js [lang]="'typescript'">
import { Observable, concatMap } from 'rxjs';

// This is the source observable
const numbers$ = new Observable<number>((observer) => {
  observer.next(1);
  observer.next(2);
  observer.next(0);
  observer.next(3);
});

// Use the pipe method to add operators
numbers$
  .pipe(
    concatMap(
      (number) =>
        new Observable((observer) => {
          if (number === 0) {
            setTimeout(() => {
              observer.error('No existences');
            }, 1000);
          } else if (number == 1) {
            setTimeout(() => {
              observer.next('üçé'.repeat(number));
              observer.complete();
            }, 1000);
          } else {
            observer.next('üçé'.repeat(number));
            observer.complete();
          }
        })
    )
  )
  .subscribe(
    (value) => console.log(`The next value is: ${value}`),
    (error) => console.error(`There is an error: ${error}`)
  );

// Output
// ======
// The next value is: üçé
// The next value is: üçéüçé
// There is an error: No existences
</textarea>

<p>
  En este ejemplo tenemos un Observable que emite n√∫meros, y por cada n√∫mero tenemos otro observable que nos emite
  tantas manzanas como diga ese n√∫mero. En el momento que hay un error en cualquiera de los Observables este se emite al
  subscriptor.
</p>

<p>
  Primero se emite el elemento n√∫mero 1. Entonces se crea un nuevo observable y al cabo de un segundo se emite una
  manzana. A continuaci√≥n se emite el elemento n√∫mero 2, pero las dos manzanas no ser√°n entregadas hasta que se emita la
  primera manzana, porque hasta que no complete el primer Observable, no se subcribe al siguiente. Lo mismo pasa con el
  elemento n√∫mero 0. Hasta que no se emita la primera manzana y luego las otras dos, no se producir√° el error. Al
  Observable creado por el elemento n√∫mero 3 no se llegar√° a subscribir ni emitir las tres manzanas, porque antes se
  producir√° el error con el elemento n√∫mero 0.
</p>

<p>
  A continuaci√≥n te dejo un simulador para que pruebes:
</p>

<app-demo-container class="demo-container">
  <app-conveyor-controller class="main-conveyor-controller" [button1]="{value: 'üöó', type: ObservableEventType.ERROR}"
    [button2]="{value: 'üñêÔ∏è', type: ObservableEventType.COMPLETE}"
    [button3]="{value: '1Ô∏è‚É£', type: ObservableEventType.NEXT}"
    [button4]="{value: '2Ô∏è‚É£', type: ObservableEventType.NEXT}"
    [button5]="{value: '3Ô∏è‚É£', type: ObservableEventType.NEXT}" (onButtonClick)="onMainControllerButtonClick($event)">
  </app-conveyor-controller>

  <div class="conveyors-container">
    <div class="concatmap-conveyors-container">
      <div class="concat-map-conveyor-and-controller" *ngFor="let observable of concatMapObservables; let i = index"
        [@observableAnimation]>
        <app-conveyor-controller class="concat-map-conveyor-controller"
          [button1]="{value: 'üöó', type: ObservableEventType.ERROR}"
          [button3]="{value: 'üñêÔ∏è', type: ObservableEventType.COMPLETE}"
          [button4]="{value: observable.value, type: ObservableEventType.NEXT}"
          (onButtonClick)="onConcatMapControllerButtonClick($event, i)">
        </app-conveyor-controller>

        <app-conveyor-vertical class="concat-map-conveyor" [conveyorWorking$]="observable.conveyorWorking$"
          [addToConveyor$]="observable.addToConveyor$" (elementDelivered)="onConcatMapElementDelivered($event, i)">
        </app-conveyor-vertical>
      </div>
    </div>

    <app-conveyor-horizontal class="main-conveyor" [length]="499.5" [conveyorWorking$]="mainConveyorWorking$"
      [addToConveyor$]="addToMainConveyor$" (elementDelivered)="onMainElementDelivered($event)">
      <svg appOperator="concatMap"></svg>
    </app-conveyor-horizontal>
  </div>

  <app-subscriber class="subscriber" [showSpeechBubble$]="speechBubble$" (onSubscribe$)="onSubscribe($event)">
  </app-subscriber>
</app-demo-container>